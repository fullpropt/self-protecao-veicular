<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automação | SELF Proteção Veicular</title>
    <meta name="robots" content="noindex, nofollow">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/app.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        .automation-card {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all 0.2s;
        }
        .automation-card:hover { box-shadow: var(--shadow-lg); }
        .automation-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .automation-title {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
        }
        .automation-body {
            padding: 20px;
        }
        .automation-trigger {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--gray-50);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }
        .automation-trigger-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .automation-trigger-icon.trigger { background: rgba(var(--warning-rgb), 0.2); }
        .automation-trigger-icon.action { background: rgba(var(--success-rgb), 0.2); }
        .automation-arrow {
            text-align: center;
            color: var(--gray-400);
            font-size: 20px;
            margin: 10px 0;
        }
        .automation-footer {
            padding: 15px 20px;
            background: var(--gray-50);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .automations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: .3s;
            border-radius: 26px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--success);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
    </style>
</head>
<body>
    <button class="mobile-menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('active')">☰</button>
    <div class="sidebar-overlay"></div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.html" class="sidebar-logo">
                <img src="img/logo-self.png" alt="SELF"><span>SELF</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span class="icon icon-dashboard"></span>Painel de Controle</a></li>
                    <li class="nav-item"><a href="contatos.html" class="nav-link"><span class="icon icon-contacts"></span>Contatos</a></li>
                    <li class="nav-item"><a href="campanhas.html" class="nav-link"><span class="icon icon-campaigns"></span>Campanhas</a></li>
                    <li class="nav-item"><a href="transmissao.html" class="nav-link"><span class="icon icon-broadcast"></span>Transmissão</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Conversas</div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="inbox.html" class="nav-link"><span class="icon icon-inbox"></span>Inbox<span class="badge" style="display:none;">0</span></a></li>
                </ul>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Automação</div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="automacao.html" class="nav-link active"><span class="icon icon-automation"></span>Automação</a></li>
                    <li class="nav-item"><a href="fluxos.html" class="nav-link"><span class="icon icon-flows"></span>Fluxos de Conversa</a></li>
                    <li class="nav-item"><a href="funil.html" class="nav-link"><span class="icon icon-funnel"></span>Funil de Vendas</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Sistema</div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="whatsapp.html" class="nav-link"><span class="icon icon-whatsapp"></span>WhatsApp</a></li>
                    <li class="nav-item"><a href="configuracoes.html" class="nav-link"><span class="icon icon-settings"></span>Configurações</a></li>
                </ul>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="whatsapp-status">
                <span class="status-indicator disconnected"></span>
                <span class="whatsapp-status-text">Desconectado</span>
            </div>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <div class="page-title">
                <h1><span class="icon icon-automation icon-sm"></span> Automação</h1>
                <p>Configure regras automáticas para seus leads</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-outline" onclick="loadAutomations()"><span class="icon icon-refresh icon-sm"></span> Atualizar</button>
                <button class="btn btn-primary" onclick="openModal('newAutomationModal')"><span class="icon icon-add icon-sm"></span> Nova Automação</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary"><span class="icon icon-automation"></span></div>
                <div class="stat-content">
                    <div class="stat-value" id="totalAutomations">0</div>
                    <div class="stat-label">Total de Automações</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon success"><span class="icon icon-check"></span></div>
                <div class="stat-content">
                    <div class="stat-value" id="activeAutomations">0</div>
                    <div class="stat-label">Ativas</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon info"><span class="icon icon-export"></span></div>
                <div class="stat-content">
                    <div class="stat-value" id="totalExecutions">0</div>
                    <div class="stat-label">Execuções (7 dias)</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warning"><span class="icon icon-bolt"></span></div>
                <div class="stat-content">
                    <div class="stat-value" id="lastExecution">-</div>
                    <div class="stat-label">Última Execução</div>
                </div>
            </div>
        </div>

        <!-- Lista de Automações -->
        <div class="automations-grid" id="automationsList">
            <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="empty-state-icon icon icon-empty icon-lg"></div>
                <p>Carregando automações...</p>
            </div>
        </div>
    </main>

    <!-- Modal: Nova Automação -->
    <div class="modal-overlay" id="newAutomationModal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title"><span class="icon icon-add icon-sm"></span> Nova Automação</h3>
                <button class="modal-close" onclick="closeModal('newAutomationModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="automationForm">
                    <div class="form-group">
                        <label class="form-label required">Nome da Automação</label>
                        <input type="text" class="form-input" id="automationName" required placeholder="Ex: Boas-vindas automática">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-textarea" id="automationDescription" rows="2" placeholder="Descreva o que esta automação faz"></textarea>
                    </div>

                    <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
                    
                    <h4 style="margin-bottom: 15px;"><span class="icon icon-bolt icon-sm"></span> Gatilho (Quando executar)</h4>
                    
                    <div class="form-group">
                        <label class="form-label required">Tipo de Gatilho</label>
                        <select class="form-select" id="triggerType" onchange="updateTriggerOptions()">
                            <option value="new_lead">Novo lead cadastrado</option>
                            <option value="status_change">Mudança de status</option>
                            <option value="message_received">Mensagem recebida</option>
                            <option value="keyword">Palavra-chave detectada</option>
                            <option value="schedule">Agendamento</option>
                            <option value="inactivity">Inatividade</option>
                        </select>
                    </div>

                    <div class="form-group" id="triggerOptionsContainer">
                        <!-- Opções dinâmicas do gatilho -->
                    </div>

                    <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
                    
                    <h4 style="margin-bottom: 15px;"><span class="icon icon-target icon-sm"></span> Ação (O que fazer)</h4>
                    
                    <div class="form-group">
                        <label class="form-label required">Tipo de Ação</label>
                        <select class="form-select" id="actionType" onchange="updateActionOptions()">
                            <option value="send_message">Enviar mensagem</option>
                            <option value="change_status">Alterar status</option>
                            <option value="add_tag">Adicionar tag</option>
                            <option value="start_flow">Iniciar fluxo</option>
                            <option value="notify">Notificar equipe</option>
                        </select>
                    </div>

                    <div class="form-group" id="actionOptionsContainer">
                        <!-- Opções dinâmicas da ação -->
                    </div>

                    <div class="form-group">
                        <label class="form-label">Atraso antes da execução</label>
                        <select class="form-select" id="actionDelay">
                            <option value="0">Imediatamente</option>
                            <option value="60">1 minuto</option>
                            <option value="300">5 minutos</option>
                            <option value="600">10 minutos</option>
                            <option value="1800">30 minutos</option>
                            <option value="3600">1 hora</option>
                            <option value="86400">24 horas</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('newAutomationModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveAutomation()"><span class="icon icon-save icon-sm"></span> Salvar Automação</button>
            </div>
        </div>
    </div>

    <script type="module" src="/src/core/app.ts"></script>
    <script type="module" src="/src/pages/automacao.ts"></script>
</body>
</html>
